<!--
Copyright (c) .NET Foundation. All rights reserved.
Licensed under the Apache License, Version 2.0.

WARNING: This file is meant for building Microsoft's ASP.NET Core repos, and is not intended
for use outside of Microsoft.
-->
<Project>
    <!-- workaround https://github.com/NuGet/Home/issues/4063 -->
    <!-- workaround https://github.com/NuGet/Home/issues/3953 -->
    <Target Name="ResolveActualPackageVersions" BeforeTargets="GenerateNuspec">
        <ItemGroup>
            <_TargetFramework Include="$(TargetFrameworks)" />
        </ItemGroup>

        <MSBuild Projects="$(MSBuildProjectFile)"
                 Targets="ResolvePackageDependenciesDesignTime"
                 Properties="TargetFramework=%(_TargetFramework.Identity)">
            <Output TaskParameter="TargetOutputs" ItemName="_DependenciesDesignTime" />
        </MSBuild>

        <ItemGroup>
            <_Tmp Include="@(_ProjectReferences)" />
            <_ProjectReferences Remove="@(_ProjectReferences)" />
            <_ProjectReferences Include="@(_Tmp)">
                <PackageVersion>$(Version)</PackageVersion>
            </_ProjectReferences>

            <_FloatingVersions Include="@(_PackageReferences)" Condition="$([System.String]::new('%(Version)').EndsWith('*'))" />
            <_ResolvedFloatingVersion Include="@(_FloatingVersions)">
                <ResolvedName>%(_DependenciesDesignTime.Name)</ResolvedName>
                <Version>%(_DependenciesDesignTime.Version)</Version>
            </_ResolvedFloatingVersion>
            <_PackageReferences Remove="@(_PackageReferences)" Condition="$([System.String]::new('%(Version)').EndsWith('*'))" />
            <_PackageReferences Include="@(_ResolvedFloatingVersion)" Condition="'%(Identity)'=='%(_ResolvedFloatingVersion.ResolvedName)'" />
        </ItemGroup>


        <Message Importance="Normal" Text="Proj: %(_ProjectReferences.FileName) %(_ProjectReferences.PackageVersion)" />
        <Message Importance="Normal" Text="Pkg: %(_PackageReferences.Identity) %(_PackageReferences.Version)" />
    </Target>
    <!-- end workaround -->
</Project>